{
  "$schema": "http://json-schema.org/draft-07/schema#",
  "$id": "urn:gleam:profile:1.0.1",
  "name": "gleam-dp-profile",
  "title": "GLEAM Data Package Profile",
  "description": "Frictionless profile for GLEAM data packages. Requires core resources and allows additional resources.",
  "version": "1.0.1",
  "type": "object",
  "allOf": [
    {
      "$ref": "https://specs.frictionlessdata.io/schemas/data-package.json"
    },
    {
      "type": "object",
      "required": ["resources", "profile"],
      "properties": {
        "profile": {
          "type": "string",
          "anyOf": [
            { "const": "data-package" },
            { "pattern": "^schemas/gleam-dp-profile\\.json$" },
            { "pattern": "^gleam-dp-profile\\.json$" },
            { "pattern": "^(https?|file)://.*/gleam-dp-profile\\.json$" }
          ],
          "description": "Path/URL to the package profile, or the canonical 'data-package' alias."
        },

        "resources": {
          "type": "array",
          "minItems": 5,
          "description": "Resources in the data package. Certain core resources are required by this profile; additional resources may be included with any name.",
          "items": {
            "anyOf": [

              {
                "title": "Core resource (canonical name)",
                "type": "object",
                "required": ["name", "path", "profile"],
                "properties": {
                  "name": {
                    "type": "string",
                    "enum": [
                      "study",
                      "participants",
                      "datasets",
                      "devices",
                      "device_datasheets",
                      "participant_characteristics"
                    ],
                    "description": "Canonical resource name recognized by the GLEAM profile. Some canonical resources are required; others are optional."
                  },
                  "path": {
                    "type": "string",
                    "description": "Path to the resource file (or folder), relative to the datapackage.json."
                  },
                  "profile": {
                    "type": "string",
                    "anyOf": [
                      { "const": "tabular-data-resource" },
                      { "pattern": "^(.*/)?json-entity-resource\\.json$" },
                      { "pattern": "^(https?|file)://.*/json-entity-resource\\.json$" }
                    ]
                  },
                  "format": { "type": "string" },
                  "mediatype": { "type": "string" },
                  "schema": {
                    "type": ["string", "object"],
                    "description": "Table Schema — for tabular resources only."
                  },
                  "jsonSchema": {
                    "type": "string",
                    "description": "JSON Schema — for non-tabular resources only."
                  }
                },
                "allOf": [
                  {
                    "if": { "properties": { "profile": { "const": "tabular-data-resource" } } },
                    "then": {
                      "required": ["schema", "mediatype"],
                      "properties": {
                        "mediatype": { "enum": ["text/csv", "application/json"] }
                      }
                    }
                  },
                  {
                    "if": {
                      "properties": {
                        "profile": {
                          "anyOf": [
                            { "pattern": "json-entity-resource\\.json$" },
                            { "pattern": "^(https?|file)://.*/json-entity-resource\\.json$" }
                          ]
                        }
                      }
                    },
                    "then": {
                      "required": ["jsonSchema", "mediatype"],
                      "properties": {
                        "mediatype": { "const": "application/json" }
                      }
                    }
                  }
                ]
              },

              {
                "title": "Additional resource (any name allowed)",
                "type": "object",
                "required": ["name", "path", "profile"],
                "properties": {
                  "name": {
                    "type": "string",
                    "description": "Name of an additional, non-core resource."
                  },
                  "path": { "type": "string" },
                  "profile": {
                    "type": "string",
                    "anyOf": [
                      { "const": "tabular-data-resource" },
                      { "pattern": "^(.*/)?json-entity-resource\\.json$" },
                      { "pattern": "^(https?|file)://.*/json-entity-resource\\.json$" }
                    ]
                  },
                  "format": { "type": "string" },
                  "mediatype": { "type": "string" },
                  "schema": { "type": ["string", "object"] },
                  "jsonSchema": { "type": "string" }
                },
                "allOf": [
                  {
                    "not": {
                      "properties": {
                        "name": {
                          "enum": [
                            "study",
                            "participants",
                            "datasets",
                            "devices",
                            "device_datasheets",
                            "participant_characteristics"
                          ]
                        }
                      },
                      "required": ["name"]
                    }
                  },
                  {
                    "if": { "properties": { "profile": { "const": "tabular-data-resource" } } },
                    "then": {
                      "required": ["schema", "mediatype"],
                      "properties": {
                        "mediatype": { "enum": ["text/csv", "application/json"] }
                      }
                    }
                  },
                  {
                    "if": {
                      "properties": {
                        "profile": {
                          "anyOf": [
                            { "pattern": "json-entity-resource\\.json$" },
                            { "pattern": "^(https?|file)://.*/json-entity-resource\\.json$" }
                          ]
                        }
                      }
                    },
                    "then": {
                      "required": ["jsonSchema", "mediatype"],
                      "properties": {
                        "mediatype": { "const": "application/json" }
                      }
                    }
                  }
                ]
              }
            ]
          },

          "allOf": [
            { "contains": { "properties": { "name": { "const": "study" } } } },
            { "contains": { "properties": { "name": { "const": "participants" } } } },
            { "contains": { "properties": { "name": { "const": "datasets" } } } },
            { "contains": { "properties": { "name": { "const": "devices" } } } },
            { "contains": { "properties": { "name": { "const": "device_datasheets" } } } }
          ]
        }
      }
    }
  ]
}